Version 1
SubGoalCombiner SGC_AND
INITSECTION

KBSECTION
QRY
LLPARTY_QRY_ClearGlobalFlag((STRING)_Flag)
THEN
GlobalClearFlag(_Flag);

//REGION FLAG_COMMANDS
IF
GlobalFlagSet("LLPARTY_Commands_IncreaseMaxPartySize")
AND
NOT DB_LLPARTY_Temp_NextMaxPartySize(_)
AND
DB_LLPARTY_MaxPartySize(_Max)
THEN
DB_LLPARTY_Temp_NextMaxPartySize(_Max);

IF
GlobalFlagSet("LLPARTY_Commands_DecreaseMaxPartySize")
AND
NOT DB_LLPARTY_Temp_NextMaxPartySize(_)
AND
DB_LLPARTY_MaxPartySize(_Max)
THEN
DB_LLPARTY_Temp_NextMaxPartySize(_Max);

IF
GlobalFlagSet("LLPARTY_Commands_IncreaseMaxPartySize")
AND
LLPARTY_QRY_ClearGlobalFlag("LLPARTY_Commands_IncreaseMaxPartySize")
AND
DB_LLPARTY_Temp_NextMaxPartySize(_Max)
AND
IntegerSum(_Max, 1, _NextMax)
AND
_NextMax <= 10
AND
IntegertoString(_NextMax, _NextStr)
THEN
LLPARTY_Log("[LLPARTY:Settings:IncreaseMaxPartySize] Next max party size set to [",_NextStr,"].");
SysClear("DB_LLPARTY_Temp_NextMaxPartySize", 1);
DB_LLPARTY_Temp_NextMaxPartySize(_NextMax);
LLPARTY_Settings_UpdateDialogVars();
GlobalSetFlag("LLPARTY_Settings_MaxPartySizeChanged");

IF
GlobalFlagSet("LLPARTY_Commands_DecreaseMaxPartySize")
AND
LLPARTY_QRY_ClearGlobalFlag("LLPARTY_Commands_DecreaseMaxPartySize")
AND
DB_LLPARTY_Temp_NextMaxPartySize(_Max)
AND
IntegerSubtract(_Max, 1, _NextMax)
AND
_NextMax >= 4
AND
IntegertoString(_NextMax, _NextStr)
THEN
LLPARTY_Log("[LLPARTY:Settings:IncreaseMaxPartySize] Next max party size set to [",_NextStr,"].");
SysClear("DB_LLPARTY_Temp_NextMaxPartySize", 1);
DB_LLPARTY_Temp_NextMaxPartySize(_NextMax);
LLPARTY_Settings_UpdateDialogVars();
GlobalSetFlag("LLPARTY_Settings_MaxPartySizeChanged");

IF
GlobalFlagSet("LLPARTY_Commands_ConfirmPartySizeChanges")
AND
LLPARTY_QRY_ClearGlobalFlag("LLPARTY_Commands_ConfirmPartySizeChanges")
AND
DB_LLPARTY_MaxPartySize(_Max)
AND
DB_LLPARTY_Temp_NextMaxPartySize(_NextMax)
AND
_Max != _NextMax
AND
IntegertoString(_NextMax, _IntStr)
THEN
LLPARTY_Log("[LLPARTY:Settings:ConfirmPartySizeChanges] Setting max party size to [",_IntStr,"] and re-installing.");
SysClear("DB_LLPARTY_Temp_NextMaxPartySize", 1);
SysClear("DB_LLPARTY_MaxPartySize", 1);
DB_LLPARTY_MaxPartySize(_NextMax);
Proc_CheckPartyFull();
LLPARTY_InstallMod();
LLPARTY_Settings_UpdateDialogVars();

IF
GlobalFlagSet("LLPARTY_Commands_ConfirmPartySizeChanges")
AND
LLPARTY_QRY_ClearGlobalFlag("LLPARTY_Commands_ConfirmPartySizeChanges")
AND
DB_LLPARTY_MaxPartySize(_Max)
AND
DB_LLPARTY_Temp_NextMaxPartySize(_NextMax)
AND
_Max == _NextMax
THEN
SysClear("DB_LLPARTY_Temp_NextMaxPartySize", 1);
LLPARTY_Log("[LLPARTY:Settings:ConfirmPartySizeChanges] Next party size and current match. Skipping re-initialization.");
LLPARTY_Settings_UpdateDialogVars();

IF
GlobalFlagSet("LLPARTY_Commands_ConfirmPartySizeChanges")
AND
DB_LLPARTY_MaxPartySize(6)
AND
DB_DialogName("LLPARTY_SettingsMenu", _Instance)
AND
DialogGetInvolvedPlayer(_Instance, 1, _Player)
THEN
ObjectSetFlag(_Player, "LLPARTY_DefaultMaxPartySizeIsSet");

IF
GlobalFlagSet("LLPARTY_Commands_ConfirmPartySizeChanges")
THEN
GlobalClearFlag("LLPARTY_Settings_MaxPartySizeChanged");

IF
GlobalFlagSet("LLPARTY_Commands_CancelPartySizeChanges")
AND
LLPARTY_QRY_ClearGlobalFlag("LLPARTY_Commands_CancelPartySizeChanges")
THEN
SysClear("DB_LLPARTY_Temp_NextMaxPartySize", 1);
LLPARTY_Settings_UpdateDialogVars();
GlobalClearFlag("LLPARTY_Settings_MaxPartySizeChanged");

IF
GlobalFlagSet("LLPARTY_Commands_ReInitPartySize")
THEN
GlobalClearFlag("LLPARTY_Commands_ReInitPartySize");
Proc_CheckPartyFull();
LLPARTY_InstallMod();

IF
GlobalFlagSet("LLPARTY_Commands_ResetPartySizeToDefault")
THEN
LLPARTY_Log("[LLPARTY:Settings:ResetPartySizeToDefault] Next max party size set to [6].");
GlobalClearFlag("LLPARTY_Commands_ResetPartySizeToDefault");
SysClear("DB_LLPARTY_Temp_NextMaxPartySize", 1);
DB_LLPARTY_Temp_NextMaxPartySize(6);
LLPARTY_Settings_UpdateDialogVars();
GlobalSetFlag("LLPARTY_Settings_MaxPartySizeChanged");

IF
GlobalFlagSet("LLPARTY_Commands_ResetPartySizeToDOS2DEDefault")
THEN
LLPARTY_Log("[LLPARTY:Settings:ResetPartySizeToDefault] Next max party size set to [4].");
GlobalClearFlag("LLPARTY_Commands_ResetPartySizeToDOS2DEDefault");
SysClear("DB_LLPARTY_Temp_NextMaxPartySize", 1);
DB_LLPARTY_Temp_NextMaxPartySize(4);
LLPARTY_Settings_UpdateDialogVars();
GlobalSetFlag("LLPARTY_Settings_MaxPartySizeChanged");
//END_REGION

//REGION DIALOG_EVENTS
PROC
LLPARTY_Settings_UpdateDialogVars()
AND
DB_LLPARTY_Temp_NextMaxPartySize(_NextMax)
THEN
DialogSetVariableInt("LLPARTY_SettingsMenu", "LLPARTY_MaxPartySize_6e79a6d2-a814-4efa-8ccd-1b9d4810024b", _NextMax);

PROC
LLPARTY_Settings_UpdateDialogVars()
AND
NOT DB_LLPARTY_Temp_NextMaxPartySize(_)
AND
DB_LLPARTY_MaxPartySize(_Max)
THEN
DialogSetVariableInt("LLPARTY_SettingsMenu", "LLPARTY_MaxPartySize_6e79a6d2-a814-4efa-8ccd-1b9d4810024b", _Max);

IF
DialogStarted("LLPARTY_SettingsMenu", _Instance)
AND
CharacterGetHostCharacter(_Host)
THEN
UserSetFlag(_Host, "LLPARTY_IsHost", _Instance);
LLPARTY_Settings_UpdateDialogVars();

IF
DialogStarted("LLPARTY_SettingsMenu", _Instance)
AND
DialogGetInvolvedPlayer(_Instance, 1, _Player)
AND
DB_LLPARTY_MaxPartySize(6)
THEN
ObjectSetFlag(_Player, "LLPARTY_DefaultMaxPartySizeIsSet");

IF
DialogEnded("LLPARTY_SettingsMenu", _Instance)
AND
CharacterGetHostCharacter(_Host)
THEN
UserClearFlag(_Host, "LLPARTY_IsHost", _Instance);

IF
DialogEnded("LLPARTY_SettingsMenu", _Instance)
AND
DialogGetInvolvedPlayer(_Instance, 1, _Player)
THEN
ObjectClearFlag(_Player, "LLPARTY_DefaultMaxPartySizeIsSet");
//END_REGION

//REGION OPEN_EVENTS
IF
TextEventSet("llparty_settings")
AND
CharacterGetHostCharacter(_Host)
THEN
Proc_StartDialog(0, "LLPARTY_SettingsMenu", _Host, _Host);

PROC
ProcBlockUseOfItem(_Player, _Book)
AND
GetTemplate(_Book, "BOOK_LLPARTY_SettingsMenu_a72cac8f-499b-4822-81ab-62b78b487ea0")
AND
CharacterIsInCombat(_Player, 1)
THEN
CharacterStatusText(_Player, "<font color='#FF0000'>*You can't use that in combat!*</font>");
DB_CustomUseItemResponse(_Player, _Book, 0);

IF
CharacterUsedItemTemplate(_Player, "BOOK_LLPARTY_SettingsMenu_a72cac8f-499b-4822-81ab-62b78b487ea0", _Book)
AND
QRY_SpeakerIsAvailable(_Player)
THEN
Proc_StartDialog(0, "LLPARTY_SettingsMenu", _Player, _Player);
//END_REGION

//REGION ADD_EVENTS
IF
GameStarted(_,_)
AND
CharacterGetHostCharacter(_Host)
AND
NOT GetItemForItemTemplateInPartyInventory(_Host, "BOOK_LLPARTY_SettingsMenu_a72cac8f-499b-4822-81ab-62b78b487ea0", _)
AND
NOT UserGetFlag(_Host, "LLPARTY_InitialSettingsBookAdded", 1)
THEN
ItemTemplateAddTo("BOOK_LLPARTY_SettingsMenu_a72cac8f-499b-4822-81ab-62b78b487ea0", _Host, 1, 1);
UserSetFlag(_Host, "LLPARTY_InitialSettingsBookAdded", 0);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "LaughingLeader_PartySizeEvolved"
